<Window
  x:Class="YXSTool.View.MainWindow"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
  xmlns:i="http://schemas.xaml/behaviors"
  xmlns:local="clr-namespace:YXSTool.View"
  xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
  xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
  xmlns:vm="clr-namespace:YXSTool.ViewModel"
  Title="YXSTool"
  Width="1024"
  Height="720"
  d:DataContext="{d:DesignInstance Type=vm:MainViewModel}"
  AllowsTransparency="True"
  Style="{StaticResource MaterialDesignWindow}"
  WindowStartupLocation="CenterScreen"
  WindowStyle="None"
  mc:Ignorable="d">
  <Window.Resources>
    <ResourceDictionary>
      <ResourceDictionary.MergedDictionaries>
        <ResourceDictionary Source="pack://application:,,,/MaterialDesignThemes.Wpf;component/Themes/MaterialDesignTheme.PopupBox.xaml" />
      </ResourceDictionary.MergedDictionaries>

    </ResourceDictionary>
  </Window.Resources>

  <TabControl
    ItemsSource="{Binding TabItems}"
    MouseDoubleClick="TabControl_MouseDoubleClick"
    MouseMove="TabControl_MouseMove"
    SelectedIndex="{Binding SelectedTabIndex, Mode=TwoWay}">
    <TabControl.Template>
      <ControlTemplate TargetType="TabControl">
        <Grid
          VerticalAlignment="Stretch"
          ClipToBounds="True"
          KeyboardNavigation.TabNavigation="Local">
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
          </Grid.RowDefinitions>

          <!--  标签栏容器  -->
          <Grid
            Grid.Row="0"
            VerticalAlignment="Stretch"
            Background="{TemplateBinding Background}">
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="Auto" />
              <ColumnDefinition Width="Auto" />
              <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!--  TabPanel - 显示所有标签  -->
            <TabPanel
              Grid.Column="0"
              Panel.ZIndex="1"
              IsItemsHost="True"
              KeyboardNavigation.TabIndex="1"
              KeyboardNavigation.TabNavigation="Local" />

            <!--  Add 按钮 - 紧挨着标签  -->
            <materialDesign:Card
              x:Name="_addMenu"
              Grid.Column="1"
              Background="Transparent">
              <Menu materialDesign:MenuAssist.MenuItemsPresenterMargin="0" materialDesign:MenuAssist.TopLevelMenuItemHeight="{Binding RelativeSource={RelativeSource FindAncestor, AncestorType=materialDesign:Card}, Path=ActualHeight}">
                <MenuItem ItemsSource="{Binding DataContext.TabItemInfos, RelativeSource={RelativeSource AncestorType=TabControl}}">
                  <MenuItem.Header>
                    <materialDesign:PackIcon Kind="Plus" />
                  </MenuItem.Header>
                  <MenuItem.ItemTemplate>
                    <DataTemplate>
                      <StackPanel
                        Margin="0,2"
                        VerticalAlignment="Center"
                        Orientation="Horizontal">
                        <materialDesign:PackIcon
                          Margin="0,0,4,0"
                          VerticalAlignment="Center"
                          Foreground="MediumPurple"
                          Kind="{Binding Icon}" />
                        <TextBlock VerticalAlignment="Center" Text="{Binding Header}" />
                      </StackPanel>
                    </DataTemplate>
                  </MenuItem.ItemTemplate>
                  <MenuItem.ItemContainerStyle>
                    <Style BasedOn="{StaticResource MaterialDesignMenuItem}" TargetType="MenuItem">
                      <Setter Property="Command" Value="{Binding DataContext.AddTabItemCommand, RelativeSource={RelativeSource AncestorType=TabControl}}" />
                      <Setter Property="CommandParameter" Value="{Binding Header}" />
                    </Style>
                  </MenuItem.ItemContainerStyle>
                </MenuItem>
              </Menu>
            </materialDesign:Card>

            <!--  右侧按钮容器  -->
            <StackPanel
              Grid.Column="2"
              Margin="0"
              HorizontalAlignment="Right"
              VerticalAlignment="Stretch"
              Background="Transparent"
              Orientation="Horizontal">
              <Button
                Height="{Binding Height, ElementName=_addMenu}"
                Command="{Binding DataContext.MinimizeCommand, RelativeSource={RelativeSource AncestorType=TabControl}}"
                Style="{StaticResource MaterialDesignFlatLightButton}">
                <materialDesign:PackIcon Kind="WindowMinimize" />
              </Button>
              <Button
                Height="{Binding Height, ElementName=_addMenu}"
                Command="{Binding DataContext.CloseCommand, RelativeSource={RelativeSource AncestorType=TabControl}}"
                Style="{StaticResource MaterialDesignFlatLightButton}">
                <materialDesign:PackIcon Kind="WindowClose" />
              </Button>
            </StackPanel>
          </Grid>

          <!--  内容区域  -->
          <ContentPresenter
            Name="PART_SelectedContentHost"
            Grid.Row="1"
            ContentSource="SelectedContent" />
        </Grid>
      </ControlTemplate>
    </TabControl.Template>

    <TabControl.ItemContainerStyle>
      <Style BasedOn="{StaticResource MaterialDesignTabItem}" TargetType="TabItem">
        <Setter Property="Padding" Value="8,0" />
        <Setter Property="Height" Value="38" />
      </Style>
    </TabControl.ItemContainerStyle>

    <TabControl.ItemTemplate>
      <DataTemplate>
        <StackPanel VerticalAlignment="Center" Orientation="Horizontal">
          <TextBlock VerticalAlignment="Center">
            <materialDesign:PackIcon Kind="{Binding Icon}" />
          </TextBlock>
          <TextBlock
            Margin="8,0"
            VerticalAlignment="Center"
            FontSize="16"
            Text="{Binding Header}" />
          <Button
            VerticalAlignment="Center"
            Command="{Binding DataContext.RemoveTabItemCommand, RelativeSource={RelativeSource AncestorType=Window}}"
            CommandParameter="{Binding Header}">
            <Button.Template>
              <ControlTemplate>
                <materialDesign:PackIcon
                  VerticalAlignment="Center"
                  Background="Transparent"
                  Foreground="Red"
                  Kind="Close" />
              </ControlTemplate>
            </Button.Template>
          </Button>
        </StackPanel>
      </DataTemplate>
    </TabControl.ItemTemplate>

    <TabControl.ContentTemplate>
      <DataTemplate>
        <ContentControl Padding="0" Content="{Binding Content}" />
      </DataTemplate>
    </TabControl.ContentTemplate>
  </TabControl>
</Window>
